<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>V√≤ng quay h·ªçc s·ªë & t·ª´ v·ª±ng</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin:0; background:#f6f7fb; color:#111; }
    .wrap { max-width: 1040px; margin: 24px auto; padding: 0 16px; }
    .card { background:#fff; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.06); padding:16px; }
    h1 { font-size:18px; margin:0 0 10px; }
    h2 { font-size:14px; margin:0; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .grid { display:grid; grid-template-columns: 1.25fr .75fr; gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }

    input, button, textarea, select {
      padding:10px 12px; border-radius:10px; border:1px solid #d7dbe7;
      background:#fff; font-size:14px;
    }
    textarea { width:100%; resize:vertical; }
    button { cursor:pointer; border:0; background:#111; color:#fff; }
    button.secondary { background:#4b5563; }
    button.good { background:#16a34a; }
    button.bad { background:#dc2626; }
    button.ghost { background:#fff; color:#111; border:1px solid #d7dbe7; }
    button:disabled { opacity:.55; cursor:not-allowed; }

    .pill {
      display:inline-flex; gap:8px; align-items:center; padding:8px 10px; border-radius:999px;
      background:#eef2ff; color:#1e3a8a; font-size:13px;
    }

    .big {
      display:grid; place-items:center; padding:14px;
      border-radius:14px; background:#0b1220; color:#fff;
      min-height:180px;
    }
    .hero { text-align:center; }
    .mainText { font-size:44px; font-weight:850; letter-spacing:.4px; }
    .subText { opacity:.85; margin-top:8px; font-size:13px; line-height:1.35; }
    .metaLine { margin-top:10px; font-size:13px; opacity:.9; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; padding:2px 6px; border:1px solid #d7dbe7; border-bottom-width:2px; border-radius:6px; background:#fff; }

    hr { border:0; border-top:1px solid #e7e9f2; margin:14px 0; }

    .panel { border:1px solid #e7e9f2; border-radius:12px; overflow:hidden; }
    .panelHead {
      padding:10px 12px; background:#fafbff; border-bottom:1px solid #e7e9f2;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .panelBody { padding:10px 12px; max-height:280px; overflow:auto; font-size:13px; }
    .muted { color:#6b7280; font-size:12px; }
    .item { padding:6px 0; border-bottom:1px dashed #eceef6; }
    .item:last-child{ border-bottom:0; }

    .hide { display:none !important; }

    .choiceGrid {
      display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:10px;
    }
    @media (max-width: 700px){ .choiceGrid{ grid-template-columns:1fr; } }
    .choice {
      border:1px solid #e7e9f2; border-radius:14px; padding:14px;
      background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.04);
    }
    .choiceTitle { font-size:16px; font-weight:750; margin:0 0 6px; }
    .choiceDesc { margin:0 0 12px; color:#4b5563; font-size:13px; line-height:1.35; }
    .tag { display:inline-flex; padding:6px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; color:#111; }

    .answerBox {
      width:100%;
      border-radius:12px;
      border:1px solid #d7dbe7;
      padding:10px 12px;
      font-size:15px;
    }
    .statusOk { color:#16a34a; font-weight:700; }
    .statusBad { color:#dc2626; font-weight:700; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <h1 id="appTitle">V√≤ng quay h·ªçc s·ªë & t·ª´ v·ª±ng</h1>
        <div class="row">
          <button class="ghost" id="btnHome" title="Tr·ªü v·ªÅ menu">Tr·ªü ra</button>
          <button class="ghost" id="btnResetAll" title="Reset to√†n b·ªô app">Reset app</button>
        </div>
      </div>

      <!-- HOME -->
      <div id="screenHome">
        <div class="row">
          <span class="pill">üé≤ Quay ng·∫´u nhi√™n</span>
          <span class="pill">‚õî Ch∆∞a qua ‚Üí quay l·∫°i v√≤ng</span>
          <span class="pill">‚úÖ Qua ‚Üí lo·∫°i kh·ªèi v√≤ng</span>
        </div>

        <div class="choiceGrid">
          <div class="choice">
            <div class="choiceTitle">1) Ch·ªâ quay s·ªë</div>
            <p class="choiceDesc">D√πng ƒë·ªÉ g·ªçi s·ªë theo th·ª© t·ª± ng·∫´u nhi√™n. C√≥ Qua/Ch∆∞a qua, Undo, T·ª± quay.</p>
            <div class="row" style="justify-content:space-between;">
              <span class="tag">Ph√π h·ª£p: h·ªçc/thi/ƒëi·ªÉm danh</span>
              <button id="goNumbers">V√†o m·ª•c S·ªë</button>
            </div>
          </div>

          <div class="choice">
            <div class="choiceTitle">2) Quay t·ª´ v·ª±ng (2 chi·ªÅu)</div>
            <p class="choiceDesc">Hi·ªán t·ª´ ‚Üí g√µ nghƒ©a ho·∫∑c hi·ªán nghƒ©a ‚Üí g√µ t·ª´. T·ª´ k√®m phi√™n √¢m + t·ª´ lo·∫°i. Danh s√°ch m·∫∑c ƒë·ªãnh thu g·ªçn.</p>
            <div class="row" style="justify-content:space-between;">
              <span class="tag">Ph√π h·ª£p: h·ªçc t·ª´ tr√™n gi·∫•y</span>
              <button id="goVocab">V√†o m·ª•c T·ª´ v·ª±ng</button>
            </div>
          </div>
        </div>

        <hr/>
        <div class="muted">
          Ph√≠m t·∫Øt trong c√°c m·ª•c: <span class="kbd">Space</span> Next ‚Ä¢ <span class="kbd">Enter</span> Qua/ƒê√∫ng ‚Ä¢ <span class="kbd">F</span> Ch∆∞a qua/Sai ‚Ä¢ <span class="kbd">Ctrl/‚åò+Z</span> Undo
        </div>
      </div>

      <!-- NUMBERS -->
      <div id="screenNumbers" class="hide">
        <div class="row">
          <span class="pill">üî¢ M·ª•c: Quay s·ªë</span>
          <span class="pill">üé≤ Next = ch·ªçn ng·∫´u nhi√™n</span>
          <span class="pill">‚õî Ch∆∞a qua = th√™m l·∫°i v√≤ng</span>
        </div>

        <hr/>

        <div class="grid">
          <!-- LEFT -->
          <div>
            <div class="big">
              <div class="hero">
                <div class="mainText" id="numCurrent">‚Äî</div>
                <div class="subText" id="numMeta">Nh·∫≠p danh s√°ch s·ªë b√™n ph·∫£i r·ªìi b·∫•m ‚ÄúB·∫Øt ƒë·∫ßu‚Äù.</div>
                <div class="metaLine" id="numStatusLine"></div>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="secondary" id="numNext">Next (Space)</button>
              <button class="good" id="numPass" disabled>Qua (Enter)</button>
              <button class="bad" id="numFail" disabled>Ch∆∞a qua (F)</button>
              <button class="ghost" id="numUndo" disabled>Undo</button>
            </div>

            <div class="row" style="margin-top:12px;">
              <label class="row" style="gap:8px;">
                <input type="checkbox" id="numAutoRun" />
                <span>T·ª± quay</span>
              </label>
              <label class="row" style="gap:8px;">
                <span class="muted">M·ªói</span>
                <input type="number" id="numAutoMs" min="400" step="100" value="1200" style="width:120px;" />
                <span class="muted">ms</span>
              </label>
              <span class="pill" id="numStats">C√≤n: 0 ‚Ä¢ Qua: 0 ‚Ä¢ Ch∆∞a qua: 0</span>
            </div>

            <div class="row" style="margin-top:14px; gap:12px;">
              <div class="panel" style="flex:1;">
                <div class="panelHead">
                  <h2>üìå C√≤n trong v√≤ng quay</h2>
                  <button class="ghost" data-toggle="numPool">M·ªü</button>
                </div>
                <div class="panelBody hide" id="numPoolBody"></div>
              </div>

              <div class="panel" style="flex:1;">
                <div class="panelHead">
                  <h2>üü† Danh s√°ch ‚ÄúCh∆∞a qua‚Äù</h2>
                  <button class="ghost" data-toggle="numFails">M·ªü</button>
                </div>
                <div class="panelBody hide" id="numFailsBody"></div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div>
            <div class="panel">
              <div class="panelHead">
                <h2>‚öôÔ∏è Nh·∫≠p danh s√°ch s·ªë</h2>
                <div class="row">
                  <button class="ghost" id="numExport">Export CSV</button>
                  <button class="ghost" id="numReset">Reset m·ª•c</button>
                </div>
              </div>
              <div class="panelBody" style="max-height:none;">
                <div class="row">
                  <label>
                    <div class="muted">T·ª´ s·ªë</div>
                    <input type="number" id="numStart" value="1" />
                  </label>
                  <label>
                    <div class="muted">ƒê·∫øn s·ªë</div>
                    <input type="number" id="numEnd" value="50" />
                  </label>
                  <button id="numBuild">B·∫Øt ƒë·∫ßu (t·∫°o v√≤ng)</button>
                </div>

                <div style="margin:12px 0 6px;" class="muted">
                  Ho·∫∑c nh·∫≠p danh s√°ch t√πy √Ω (m·ªói d√≤ng 1 s·ªë/m√£):
                </div>
                <textarea id="numCustom" rows="7" placeholder="V√≠ d·ª•:
A01
A02
B10"></textarea>

                <div class="row" style="margin-top:10px;">
                  <button class="secondary" id="numUseCustom">D√πng danh s√°ch t√πy √Ω</button>
                  <button class="ghost" id="numShuffle">Tr·ªôn v√≤ng c√≤n l·∫°i</button>
                </div>

                <hr/>

                <div class="panel">
                  <div class="panelHead">
                    <h2>üßæ Nh·∫≠t k√Ω</h2>
                    <button class="ghost" data-toggle="numLog">M·ªü</button>
                  </div>
                  <div class="panelBody hide" id="numLogBody"></div>
                </div>

                <div class="muted" style="margin-top:10px;">
                  Next s·∫Ω r√∫t 1 s·ªë ra kh·ªèi v√≤ng ƒë·ªÉ tr√°nh l·∫∑p ngay. ‚ÄúCh∆∞a qua‚Äù s·∫Ω ƒë∆∞a l·∫°i s·ªë ƒë√≥ v√†o v√≤ng.
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- VOCAB -->
      <div id="screenVocab" class="hide">
        <div class="row">
          <span class="pill">üìö M·ª•c: Quay t·ª´ v·ª±ng</span>
          <span class="pill">‚Üî 2 chi·ªÅu ki·ªÉm tra</span>
          <span class="pill">üôà Danh s√°ch m·∫∑c ƒë·ªãnh thu g·ªçn</span>
        </div>

        <hr/>

        <div class="grid">
          <!-- LEFT -->
          <div>
            <div class="big">
              <div class="hero">
                <div class="mainText" id="vbPromptMain">‚Äî</div>
                <div class="subText" id="vbPromptSub">Nh·∫≠p danh s√°ch b√™n ph·∫£i r·ªìi b·∫•m ‚ÄúB·∫Øt ƒë·∫ßu‚Äù.</div>
                <div class="metaLine" id="vbModeLine"></div>
              </div>
            </div>

            <div class="row" style="margin-top:12px;">
              <button class="secondary" id="vbNext">Next (Space)</button>
              <button class="good" id="vbPass" disabled>Qua/ƒê√∫ng (Enter)</button>
              <button class="bad" id="vbFail" disabled>Ch∆∞a qua/Sai (F)</button>
              <button class="ghost" id="vbUndo" disabled>Undo</button>
            </div>

            <div class="row" style="margin-top:12px;">
              <input id="vbAnswer" class="answerBox" placeholder="G√µ ƒë√°p √°n ·ªü ƒë√¢y r·ªìi b·∫•m Enter (ho·∫∑c b·∫•m Ki·ªÉm tra)" />
              <button class="ghost" id="vbCheck">Ki·ªÉm tra</button>
              <button class="ghost" id="vbReveal">Hi·ªán ƒë√°p √°n</button>
            </div>

            <div class="row" style="margin-top:10px;">
              <span class="pill" id="vbStats">C√≤n: 0 ‚Ä¢ Qua: 0 ‚Ä¢ Ch∆∞a qua: 0</span>
              <span id="vbJudge" class="muted"></span>
            </div>

            <div class="row" style="margin-top:12px;">
              <label class="row" style="gap:8px;">
                <input type="checkbox" id="vbAutoRun" />
                <span>T·ª± quay</span>
              </label>
              <label class="row" style="gap:8px;">
                <span class="muted">M·ªói</span>
                <input type="number" id="vbAutoMs" min="500" step="100" value="1500" style="width:120px;" />
                <span class="muted">ms</span>
              </label>
              <span class="muted">G·ª£i √Ω: T·ª± quay ch·ªâ ch·∫°y Next (kh√¥ng t·ª± ch·∫•m).</span>
            </div>

            <div class="row" style="margin-top:14px; gap:12px;">
              <div class="panel" style="flex:1;">
                <div class="panelHead">
                  <h2>üìå C√≤n trong v√≤ng quay</h2>
                  <button class="ghost" data-toggle="vbPool">M·ªü</button>
                </div>
                <div class="panelBody hide" id="vbPoolBody"></div>
              </div>

              <div class="panel" style="flex:1;">
                <div class="panelHead">
                  <h2>üü† Danh s√°ch ‚ÄúCh∆∞a qua‚Äù</h2>
                  <button class="ghost" data-toggle="vbFails">M·ªü</button>
                </div>
                <div class="panelBody hide" id="vbFailsBody"></div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div>
            <div class="panel">
              <div class="panelHead">
                <h2>‚öôÔ∏è Nh·∫≠p t·ª´ v·ª±ng</h2>
                <div class="row">
                  <button class="ghost" id="vbExport">Export CSV</button>
                  <button class="ghost" id="vbReset">Reset m·ª•c</button>
                </div>
              </div>

              <div class="panelBody" style="max-height:none;">
                <div class="row" style="justify-content:space-between;">
                  <label class="row" style="gap:8px;">
                    <span class="muted">Ch·∫ø ƒë·ªô:</span>
                    <select id="vbMode">
                      <option value="WORD_TO_MEANING">Hi·ªán t·ª´ ‚Üí g√µ nghƒ©a</option>
                      <option value="MEANING_TO_WORD">Hi·ªán nghƒ©a ‚Üí g√µ t·ª´</option>
                    </select>
                  </label>
                  <button class="ghost" id="vbShuffle">Tr·ªôn v√≤ng c√≤n l·∫°i</button>
                </div>

                <div class="muted" style="margin:10px 0 8px;">
                  ƒê·ªãnh d·∫°ng m·ªói d√≤ng: <span class="mono">t·ª´ | phi√™n √¢m | t·ª´ lo·∫°i | nghƒ©a</span><br/>
                  B·∫°n c√≥ th·ªÉ b·ªè tr·ªëng phi√™n √¢m/t·ª´ lo·∫°i, nh∆∞ng n√™n gi·ªØ d·∫•u <span class="mono">|</span> cho ƒë·ªß c·ªôt.
                  Nhi·ªÅu ƒë√°p √°n ƒë√∫ng: ngƒÉn c√°ch b·∫±ng <span class="mono">;</span> ho·∫∑c <span class="mono">/</span> (v√≠ d·ª• nghƒ©a: <span class="mono">t√°ch r·ªùi; c·∫•t c√°nh</span>).
                </div>

                <textarea id="vbList" rows="10" placeholder="V√≠ d·ª•:
take off | /te…™k …íf/ | phr.v | c·∫•t c√°nh; c·ªüi ra
sustainable | /s…ôÀàste…™n…ôbl/ | adj | b·ªÅn v·ªØng
apple | /Àà√¶p.…ôl/ | n | qu·∫£ t√°o"></textarea>

                <div class="row" style="margin-top:10px;">
                  <button id="vbStart">B·∫Øt ƒë·∫ßu (t·∫°o v√≤ng)</button>
                </div>

                <hr/>

                <div class="panel">
                  <div class="panelHead">
                    <h2>üßæ Nh·∫≠t k√Ω</h2>
                    <button class="ghost" data-toggle="vbLog">M·ªü</button>
                  </div>
                  <div class="panelBody hide" id="vbLogBody"></div>
                </div>

                <div class="muted" style="margin-top:10px;">
                  Next s·∫Ω r√∫t 1 m·ª•c ra kh·ªèi v√≤ng ƒë·ªÉ tr√°nh l·∫∑p ngay. ‚ÄúCh∆∞a qua‚Äù s·∫Ω ƒë∆∞a l·∫°i m·ª•c ƒë√≥ v√†o v√≤ng.
                </div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /screenVocab -->
    </div><!-- /card -->
  </div><!-- /wrap -->

<script>
(() => {
  // ========= Common =========
  const $ = (id) => document.getElementById(id);
  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
  const nowStr = () => {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  };
  const normalize = (s) => String(s ?? "").trim();
  const normAnswer = (s) =>
    normalize(s)
      .toLowerCase()
      .replace(/\s+/g," ")
      .replace(/[‚Äú‚Äù]/g,'"')
      .replace(/[‚Äô]/g,"'");

  function togglePanel(idBody, btn) {
    const body = $(idBody);
    const isHidden = body.classList.contains("hide");
    body.classList.toggle("hide");
    btn.textContent = isHidden ? "Thu g·ªçn" : "M·ªü";
  }

  // ========= Navigation =========
  const screens = {
    home: $("screenHome"),
    numbers: $("screenNumbers"),
    vocab: $("screenVocab"),
  };

  function showScreen(name) {
    Object.values(screens).forEach(el => el.classList.add("hide"));
    screens[name].classList.remove("hide");
    $("btnHome").disabled = (name === "home");
    $("appTitle").textContent =
      name === "numbers" ? "V√≤ng quay ‚Äî M·ª•c S·ªë" :
      name === "vocab" ? "V√≤ng quay ‚Äî M·ª•c T·ª´ v·ª±ng" :
      "V√≤ng quay h·ªçc s·ªë & t·ª´ v·ª±ng";
  }

  $("goNumbers").addEventListener("click", () => showScreen("numbers"));
  $("goVocab").addEventListener("click", () => showScreen("vocab"));
  $("btnHome").addEventListener("click", () => showScreen("home"));

  // ========= Numbers Module =========
  const LS_NUM = "spin_numbers_v3";
  const numState = {
    pool: [],
    current: null,
    passed: [],
    failed: [],      // {item, at, count}
    failCount: {},
    log: [],
    history: [],
    autoTimer: null
  };

  function numSave(){ localStorage.setItem(LS_NUM, JSON.stringify(numState)); }
  function numLoad(){
    const raw = localStorage.getItem(LS_NUM); if(!raw) return;
    try{ Object.assign(numState, JSON.parse(raw)); } catch {}
  }
  function numPushHistory(){
    numState.history.push(JSON.stringify({
      pool:numState.pool, current:numState.current, passed:numState.passed,
      failed:numState.failed, failCount:numState.failCount, log:numState.log
    }));
    if(numState.history.length>40) numState.history.shift();
    $("numUndo").disabled = numState.history.length===0;
  }
  function numUndo(){
    const snap = numState.history.pop(); if(!snap) return;
    Object.assign(numState, JSON.parse(snap));
    $("numUndo").disabled = numState.history.length===0;
    numSave(); numRender();
  }
  function numLog(action,item,note=""){
    numState.log.unshift({at:nowStr(), action, item, note});
    if(numState.log.length>200) numState.log.pop();
  }
  function numBuildRange(a,b){
    const s=Number(a), e=Number(b);
    if(!Number.isFinite(s)||!Number.isFinite(e)||e<s) return [];
    const arr=[];
    for(let i=s;i<=e;i++) arr.push(String(i));
    return arr;
  }
  function numStartWithList(list){
    if(list.length===0){ alert("Danh s√°ch tr·ªëng."); return; }
    numPushHistory();
    numState.pool=list.slice();
    numState.current=null;
    numState.passed=[];
    numState.failed=[];
    numState.failCount={};
    numState.log=[];
    numLog("INIT","-",`T·∫°o v√≤ng (${list.length} m·ª•c)`);
    numSave(); numRender();
  }
  function numPick(){
    if(numState.pool.length===0) return null;
    const idx=Math.floor(Math.random()*numState.pool.length);
    return numState.pool.splice(idx,1)[0];
  }
  function numNext(){
    if(numState.current!==null) return;
    if(numState.pool.length===0) return;
    numPushHistory();
    numState.current=numPick();
    numLog("CALL",numState.current,"Quay ng·∫´u nhi√™n");
    numSave(); numRender();
  }
  function numPass(){
    if(numState.current===null) return;
    numPushHistory();
    numState.passed.unshift({item:numState.current, at:nowStr()});
    numLog("PASS",numState.current,"Qua ‚Üí lo·∫°i kh·ªèi v√≤ng");
    numState.current=null;
    numSave(); numRender();
  }
  function numFail(){
    if(numState.current===null) return;
    numPushHistory();
    const item=numState.current;
    numState.failCount[item]=(numState.failCount[item]||0)+1;
    numState.pool.push(item);
    const rec={item, at:nowStr(), count:numState.failCount[item]};
    const idx=numState.failed.findIndex(x=>x.item===item);
    if(idx>=0) numState.failed[idx]=rec; else numState.failed.unshift(rec);
    numLog("FAIL",item,`Ch∆∞a qua (l·∫ßn ${rec.count}) ‚Üí th√™m l·∫°i v√≤ng`);
    numState.current=null;
    numSave(); numRender();
  }
  function numShuffle(){
    if(numState.pool.length<2) return;
    numPushHistory();
    for(let i=numState.pool.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [numState.pool[i], numState.pool[j]]=[numState.pool[j], numState.pool[i]];
    }
    numLog("SHUFFLE","-","Tr·ªôn v√≤ng c√≤n l·∫°i");
    numSave(); numRender();
  }
  function numExport(){
    const rows=[["time","action","item","note"]];
    for(const x of numState.log.slice().reverse()){
      rows.push([x.at,x.action,x.item,x.note||""]);
    }
    const csv=rows.map(r=>r.map(cell=>{
      const s=String(cell??"");
      return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`so-log-${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }
  function numReset(){
    const ok=confirm("Reset m·ª•c S·ªë s·∫Ω x√≥a tr·∫°ng th√°i c·ªßa m·ª•c n√†y. B·∫°n ch·∫Øc ch·ª©?");
    if(!ok) return;
    localStorage.removeItem(LS_NUM);
    Object.assign(numState,{
      pool:[], current:null, passed:[], failed:[], failCount:{}, log:[], history:[],
      autoTimer: (numState.autoTimer? (clearInterval(numState.autoTimer), null): null)
    });
    $("numAutoRun").checked=false;
    numRender();
  }
  function numSetAuto(on){
    if(numState.autoTimer){ clearInterval(numState.autoTimer); numState.autoTimer=null; }
    if(!on) return;
    const ms=Number($("numAutoMs").value);
    const interval=(Number.isFinite(ms)&&ms>=400)?ms:1200;
    numState.autoTimer=setInterval(()=>{
      if(numState.current===null && numState.pool.length>0) numNext();
    }, interval);
  }
  function numEnsureButtons(){
    const hasCurrent=numState.current!==null;
    $("numPass").disabled=!hasCurrent;
    $("numFail").disabled=!hasCurrent;
    $("numNext").disabled=hasCurrent || numState.pool.length===0;
    $("numUndo").disabled=numState.history.length===0;
  }
  function numRender(){
    // current
    if(numState.current===null){
      $("numCurrent").textContent="‚Äî";
      $("numMeta").textContent = numState.pool.length
        ? `C√≤n ${numState.pool.length} m·ª•c trong v√≤ng. B·∫•m Next ƒë·ªÉ quay.`
        : "V√≤ng quay tr·ªëng. Nh·∫≠p danh s√°ch r·ªìi b·∫•m B·∫Øt ƒë·∫ßu.";
      $("numStatusLine").textContent="";
    } else {
      $("numCurrent").textContent=numState.current;
      const c=numState.failCount[numState.current]||0;
      $("numMeta").textContent = "ƒê√°nh gi√°: qua hay ch∆∞a qua?";
      $("numStatusLine").textContent = c ? `M·ª•c n√†y ƒë√£ ‚Äúch∆∞a qua‚Äù ${c} l·∫ßn.` : "";
    }

    // stats
    $("numStats").textContent = `C√≤n: ${numState.pool.length} ‚Ä¢ Qua: ${numState.passed.length} ‚Ä¢ Ch∆∞a qua: ${numState.failed.length}`;

    // pool list
    if(numState.pool.length===0){
      $("numPoolBody").innerHTML = `<div class="muted">Kh√¥ng c√≤n m·ª•c n√†o.</div>`;
    } else {
      const view=numState.pool.slice(0,200);
      const html=view.map((x,i)=>`<div class="item"><b>${i+1}.</b> ${escapeHtml(x)}</div>`).join("");
      const more=numState.pool.length>view.length ? `<div class="muted">‚Ä¶ v√† c√≤n ${numState.pool.length-view.length} m·ª•c n·ªØa</div>` : "";
      $("numPoolBody").innerHTML = html+more;
    }

    // fails list
    if(numState.failed.length===0){
      $("numFailsBody").innerHTML = `<div class="muted">Ch∆∞a c√≥ m·ª•c ‚ÄúCh∆∞a qua‚Äù.</div>`;
    } else {
      const view=numState.failed.slice(0,200);
      $("numFailsBody").innerHTML = view.map(x=>`
        <div class="item">
          <b>${escapeHtml(x.item)}</b>
          <div class="muted">Ch∆∞a qua: ${x.count} ‚Ä¢ L√∫c: ${escapeHtml(x.at)}</div>
        </div>
      `).join("");
    }

    // log
    if(numState.log.length===0){
      $("numLogBody").innerHTML = `<div class="muted">Ch∆∞a c√≥ log.</div>`;
    } else {
      const view=numState.log.slice(0,120);
      $("numLogBody").innerHTML = view.map(x=>{
        const badge = x.action==="PASS"?"‚úÖ":x.action==="FAIL"?"‚õî":x.action==="CALL"?"üé≤":x.action==="INIT"?"‚öôÔ∏è":x.action==="SHUFFLE"?"üîÄ":"‚Ä¢";
        return `<div class="item">
          <div><b>${badge} ${escapeHtml(x.action)}</b> ‚Äî <b>${escapeHtml(x.item)}</b></div>
          <div class="muted">${escapeHtml(x.at)} ‚Ä¢ ${escapeHtml(x.note||"")}</div>
        </div>`;
      }).join("");
    }

    numEnsureButtons();
  }

  // number events
  $("numBuild").addEventListener("click", () => {
    const list=numBuildRange($("numStart").value, $("numEnd").value);
    if(list.length===0) return alert("Kho·∫£ng s·ªë kh√¥ng h·ª£p l·ªá.");
    numStartWithList(list);
  });
  $("numUseCustom").addEventListener("click", () => {
    const raw=$("numCustom").value||"";
    const list=raw.split(/\r?\n/).map(normalize).filter(Boolean);
    if(list.length===0) return alert("Danh s√°ch t√πy √Ω ƒëang tr·ªëng.");
    numStartWithList(list);
  });
  $("numNext").addEventListener("click", numNext);
  $("numPass").addEventListener("click", numPass);
  $("numFail").addEventListener("click", numFail);
  $("numUndo").addEventListener("click", numUndo);
  $("numShuffle").addEventListener("click", numShuffle);
  $("numExport").addEventListener("click", numExport);
  $("numReset").addEventListener("click", numReset);
  $("numAutoRun").addEventListener("change", (e)=> numSetAuto(e.target.checked));
  $("numAutoMs").addEventListener("change", ()=> { if($("numAutoRun").checked) numSetAuto(true); });

  // collapsible buttons (numbers)
  document.querySelectorAll('[data-toggle="numPool"]').forEach(btn=>{
    btn.addEventListener("click", ()=>togglePanel("numPoolBody", btn));
  });
  document.querySelectorAll('[data-toggle="numFails"]').forEach(btn=>{
    btn.addEventListener("click", ()=>togglePanel("numFailsBody", btn));
  });
  document.querySelectorAll('[data-toggle="numLog"]').forEach(btn=>{
    btn.addEventListener("click", ()=>togglePanel("numLogBody", btn));
  });

  // ========= Vocab Module =========
  const LS_VB = "spin_vocab_v3";
  const vbState = {
    pool: [],        // array of ids
    currentId: null,
    items: {},       // id -> {word, pron, pos, meaning}
    passed: [],
    failed: [],      // {id, at, count}
    failCount: {},
    log: [],
    history: [],
    autoTimer: null,
    mode: "WORD_TO_MEANING", // or MEANING_TO_WORD
    lastReveal: null
  };

  function vbSave(){ localStorage.setItem(LS_VB, JSON.stringify(vbState)); }
  function vbLoad(){
    const raw = localStorage.getItem(LS_VB); if(!raw) return;
    try{ Object.assign(vbState, JSON.parse(raw)); } catch {}
    // ensure select matches
    if($("vbMode")) $("vbMode").value = vbState.mode || "WORD_TO_MEANING";
  }
  function vbPushHistory(){
    vbState.history.push(JSON.stringify({
      pool:vbState.pool, currentId:vbState.currentId, items:vbState.items,
      passed:vbState.passed, failed:vbState.failed, failCount:vbState.failCount,
      log:vbState.log, mode: vbState.mode
    }));
    if(vbState.history.length>40) vbState.history.shift();
    $("vbUndo").disabled = vbState.history.length===0;
  }
  function vbUndo(){
    const snap=vbState.history.pop(); if(!snap) return;
    Object.assign(vbState, JSON.parse(snap));
    $("vbMode").value = vbState.mode || "WORD_TO_MEANING";
    $("vbUndo").disabled = vbState.history.length===0;
    vbState.lastReveal=null;
    vbSave(); vbRender();
  }
  function vbLog(action,item,note=""){
    vbState.log.unshift({at:nowStr(), action, item, note});
    if(vbState.log.length>200) vbState.log.pop();
  }
  function makeId(i){ return `w_${Date.now()}_${i}_${Math.random().toString(16).slice(2)}`; }

  function parseVocabLines(raw){
    const lines = (raw||"").split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    const items = [];
    for(const line of lines){
      // allow delimiter: | or tab
      const parts = line.split("|").map(x=>x.trim());
      let word="", pron="", pos="", meaning="";
      if(parts.length>=4){
        [word, pron, pos, meaning] = parts;
      } else {
        // try tab split
        const t=line.split("\t").map(x=>x.trim());
        if(t.length>=4){ [word, pron, pos, meaning]=t; }
        else if(t.length===2){ [word, meaning]=t; }
        else if(parts.length===2){ [word, meaning]=parts; }
        else {
          // fallback: entire line as word (no meaning)
          word=line; meaning="";
        }
      }
      word=normalize(word);
      meaning=normalize(meaning);
      pron=normalize(pron);
      pos=normalize(pos);
      if(!word && !meaning) continue;
      items.push({word, pron, pos, meaning});
    }
    return items;
  }

  function vbStart(){
    const list = parseVocabLines($("vbList").value||"");
    if(list.length===0){
      alert("Danh s√°ch t·ª´ v·ª±ng tr·ªëng ho·∫∑c sai ƒë·ªãnh d·∫°ng.");
      return;
    }
    vbPushHistory();
    vbState.items = {};
    vbState.pool = [];
    vbState.currentId = null;
    vbState.passed = [];
    vbState.failed = [];
    vbState.failCount = {};
    vbState.log = [];
    vbState.mode = $("vbMode").value || "WORD_TO_MEANING";
    vbState.lastReveal = null;

    list.forEach((it, i)=>{
      const id=makeId(i);
      vbState.items[id]=it;
      vbState.pool.push(id);
    });
    vbLog("INIT","-",`T·∫°o v√≤ng (${list.length} m·ª•c)`);
    vbSave(); vbRender();
  }

  function vbPick(){
    if(vbState.pool.length===0) return null;
    const idx=Math.floor(Math.random()*vbState.pool.length);
    return vbState.pool.splice(idx,1)[0];
  }

  function vbNext(){
    if(vbState.currentId!==null) return;
    if(vbState.pool.length===0) return;
    vbPushHistory();
    vbState.currentId = vbPick();
    vbState.lastReveal=null;
    $("vbAnswer").value="";
    $("vbJudge").textContent="";
    vbLog("CALL", vbState.currentId, "Quay ng·∫´u nhi√™n");
    vbSave(); vbRender();
    $("vbAnswer").focus();
  }

  function currentItem(){
    if(!vbState.currentId) return null;
    return vbState.items[vbState.currentId] || null;
  }

  function expectedAnswers(){
    const it=currentItem(); if(!it) return [];
    if(vbState.mode==="WORD_TO_MEANING"){
      // meaning can be multiple separated by ; or /
      const raw = it.meaning || "";
      return raw.split(/[;/]/).map(x=>normAnswer(x)).filter(Boolean);
    } else {
      // word expected
      const raw = it.word || "";
      return raw.split(/[;/]/).map(x=>normAnswer(x)).filter(Boolean);
    }
  }

  function promptText(){
    const it=currentItem(); if(!it) return {main:"‚Äî", sub:""};
    if(vbState.mode==="WORD_TO_MEANING"){
      const main = it.word || "(kh√¥ng c√≥ t·ª´)";
      const extra = [
        it.pron ? `Phi√™n √¢m: ${it.pron}` : "",
        it.pos ? `T·ª´ lo·∫°i: ${it.pos}` : ""
      ].filter(Boolean).join(" ‚Ä¢ ");
      const sub = extra ? extra : "G√µ nghƒ©a (c√≥ th·ªÉ 1 trong nhi·ªÅu nghƒ©a).";
      return {main, sub};
    } else {
      const main = it.meaning || "(kh√¥ng c√≥ nghƒ©a)";
      const sub = "G√µ t·ª´ v·ª±ng (ƒë√°p √°n l√† t·ª´).";
      return {main, sub};
    }
  }

  function vbCheck(){
    const it=currentItem();
    if(!it) return;

    const user = normAnswer($("vbAnswer").value||"");
    if(!user){
      $("vbJudge").innerHTML = `<span class="statusBad">Ch∆∞a nh·∫≠p ƒë√°p √°n.</span>`;
      return;
    }

    const exp = expectedAnswers();
    if(exp.length===0){
      $("vbJudge").innerHTML = `<span class="muted">Kh√¥ng c√≥ ƒë√°p √°n chu·∫©n ƒë·ªÉ so s√°nh (d√≤ng n√†y thi·∫øu nghƒ©a ho·∫∑c thi·∫øu t·ª´).</span>`;
      return;
    }

    const ok = exp.includes(user);
    if(ok){
      $("vbJudge").innerHTML = `<span class="statusOk">ƒê√∫ng ‚úÖ</span>`;
    } else {
      $("vbJudge").innerHTML = `<span class="statusBad">Ch∆∞a ƒë√∫ng ‚õî</span>`;
    }
    // kh√¥ng t·ª± pass/fail ƒë·ªÉ b·∫°n ch·ªß ƒë·ªông; nh∆∞ng Enter s·∫Ω pass m·∫∑c ƒë·ªãnh (ƒë√∫ng) n·∫øu b·∫°n mu·ªën.
    return ok;
  }

  function vbReveal(){
    const it=currentItem(); if(!it) return;
    let ans="";
    if(vbState.mode==="WORD_TO_MEANING"){
      ans = it.meaning || "(tr·ªëng)";
    } else {
      const extra = [
        it.word || "(tr·ªëng)",
        it.pron ? `(${it.pron})` : "",
        it.pos ? `[${it.pos}]` : ""
      ].filter(Boolean).join(" ");
      ans = extra;
    }
    vbState.lastReveal = ans;
    $("vbJudge").innerHTML = `<span class="muted">ƒê√°p √°n: </span><b>${escapeHtml(ans)}</b>`;
    vbSave();
  }

  function vbPass(){
    if(vbState.currentId===null) return;
    vbPushHistory();
    const id=vbState.currentId;
    vbState.passed.unshift({id, at:nowStr()});
    vbLog("PASS", id, "Qua/ƒê√∫ng ‚Üí lo·∫°i kh·ªèi v√≤ng");
    vbState.currentId=null;
    vbState.lastReveal=null;
    $("vbAnswer").value="";
    $("vbJudge").textContent="";
    vbSave(); vbRender();
  }

  function vbFail(){
    if(vbState.currentId===null) return;
    vbPushHistory();
    const id=vbState.currentId;
    vbState.failCount[id]=(vbState.failCount[id]||0)+1;
    vbState.pool.push(id);

    const rec={id, at:nowStr(), count:vbState.failCount[id]};
    const idx=vbState.failed.findIndex(x=>x.id===id);
    if(idx>=0) vbState.failed[idx]=rec; else vbState.failed.unshift(rec);

    vbLog("FAIL", id, `Ch∆∞a qua/Sai (l·∫ßn ${rec.count}) ‚Üí th√™m l·∫°i v√≤ng`);
    vbState.currentId=null;
    vbState.lastReveal=null;
    $("vbAnswer").value="";
    $("vbJudge").textContent="";
    vbSave(); vbRender();
  }

  function vbShuffle(){
    if(vbState.pool.length<2) return;
    vbPushHistory();
    for(let i=vbState.pool.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [vbState.pool[i], vbState.pool[j]]=[vbState.pool[j], vbState.pool[i]];
    }
    vbLog("SHUFFLE","-","Tr·ªôn v√≤ng c√≤n l·∫°i");
    vbSave(); vbRender();
  }

  function vbSetMode(){
    vbState.mode = $("vbMode").value || "WORD_TO_MEANING";
    vbState.lastReveal=null;
    vbSave(); vbRender();
  }

  function vbExport(){
    const rows=[["time","action","id","word","pron","pos","meaning","note"]];
    for(const x of vbState.log.slice().reverse()){
      const id = x.item;
      const it = vbState.items[id] || {};
      rows.push([x.at, x.action, id, it.word||"", it.pron||"", it.pos||"", it.meaning||"", x.note||""]);
    }
    const csv=rows.map(r=>r.map(cell=>{
      const s=String(cell??"");
      return /[,"\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url; a.download=`tu-vung-log-${Date.now()}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function vbReset(){
    const ok=confirm("Reset m·ª•c T·ª´ v·ª±ng s·∫Ω x√≥a tr·∫°ng th√°i c·ªßa m·ª•c n√†y. B·∫°n ch·∫Øc ch·ª©?");
    if(!ok) return;
    localStorage.removeItem(LS_VB);
    if(vbState.autoTimer){ clearInterval(vbState.autoTimer); vbState.autoTimer=null; }
    Object.assign(vbState,{
      pool:[], currentId:null, items:{}, passed:[], failed:[], failCount:{}, log:[], history:[],
      autoTimer:null, mode:"WORD_TO_MEANING", lastReveal:null
    });
    $("vbAutoRun").checked=false;
    $("vbMode").value="WORD_TO_MEANING";
    vbRender();
  }

  function vbSetAuto(on){
    if(vbState.autoTimer){ clearInterval(vbState.autoTimer); vbState.autoTimer=null; }
    if(!on) return;
    const ms=Number($("vbAutoMs").value);
    const interval=(Number.isFinite(ms)&&ms>=500)?ms:1500;
    vbState.autoTimer=setInterval(()=>{
      if(vbState.currentId===null && vbState.pool.length>0) vbNext();
    }, interval);
  }

  function vbEnsureButtons(){
    const hasCurrent = vbState.currentId!==null;
    $("vbPass").disabled = !hasCurrent;
    $("vbFail").disabled = !hasCurrent;
    $("vbNext").disabled = hasCurrent || vbState.pool.length===0;
    $("vbUndo").disabled = vbState.history.length===0;
    $("vbCheck").disabled = !hasCurrent;
    $("vbReveal").disabled = !hasCurrent;
    $("vbAnswer").disabled = !hasCurrent;
  }

  function vbRender(){
    // mode line
    $("vbModeLine").textContent =
      vbState.mode==="WORD_TO_MEANING"
        ? "Ch·∫ø ƒë·ªô: Hi·ªán t·ª´ ‚Üí g√µ nghƒ©a"
        : "Ch·∫ø ƒë·ªô: Hi·ªán nghƒ©a ‚Üí g√µ t·ª´ (t·ª´ k√®m phi√™n √¢m + t·ª´ lo·∫°i khi hi·ªán ƒë√°p √°n)";

    // current prompt
    if(vbState.currentId===null){
      $("vbPromptMain").textContent="‚Äî";
      $("vbPromptSub").textContent = vbState.pool.length
        ? `C√≤n ${vbState.pool.length} m·ª•c trong v√≤ng. B·∫•m Next ƒë·ªÉ quay.`
        : "V√≤ng quay tr·ªëng. Nh·∫≠p danh s√°ch r·ªìi b·∫•m ‚ÄúB·∫Øt ƒë·∫ßu‚Äù.";
      $("vbJudge").textContent="";
      $("vbAnswer").value="";
    } else {
      const p=promptText();
      $("vbPromptMain").textContent=p.main;
      $("vbPromptSub").textContent=p.sub;
    }

    // stats
    $("vbStats").textContent = `C√≤n: ${vbState.pool.length} ‚Ä¢ Qua: ${vbState.passed.length} ‚Ä¢ Ch∆∞a qua: ${vbState.failed.length}`;

    // pool list (collapsed by default)
    const poolBody=$("vbPoolBody");
    if(vbState.pool.length===0){
      poolBody.innerHTML = `<div class="muted">Kh√¥ng c√≤n m·ª•c n√†o.</div>`;
    } else {
      const view=vbState.pool.slice(0,200);
      poolBody.innerHTML = view.map((id,i)=>{
        const it=vbState.items[id]||{};
        // kh√¥ng show nghƒ©a trong list ƒë·ªÉ tr√°nh l·ªô; ch·ªâ show word
        const label = it.word ? it.word : `(no word)`;
        const meta = [it.pron?it.pron:"", it.pos?it.pos:""].filter(Boolean).join(" ‚Ä¢ ");
        return `<div class="item"><b>${i+1}.</b> ${escapeHtml(label)} <span class="muted">${meta?`‚Äî ${escapeHtml(meta)}`:""}</span></div>`;
      }).join("") + (vbState.pool.length>view.length ? `<div class="muted">‚Ä¶ v√† c√≤n ${vbState.pool.length-view.length} m·ª•c n·ªØa</div>` : "");
    }

    // fails list (show word but not meaning)
    const failsBody=$("vbFailsBody");
    if(vbState.failed.length===0){
      failsBody.innerHTML = `<div class="muted">Ch∆∞a c√≥ m·ª•c ‚ÄúCh∆∞a qua‚Äù.</div>`;
    } else {
      const view=vbState.failed.slice(0,200);
      failsBody.innerHTML = view.map(x=>{
        const it=vbState.items[x.id]||{};
        const w=it.word||"(no word)";
        const meta=[it.pron?it.pron:"", it.pos?it.pos:""].filter(Boolean).join(" ‚Ä¢ ");
        return `<div class="item">
          <b>${escapeHtml(w)}</b> <span class="muted">${meta?`‚Äî ${escapeHtml(meta)}`:""}</span>
          <div class="muted">Ch∆∞a qua: ${x.count} ‚Ä¢ L√∫c: ${escapeHtml(x.at)}</div>
        </div>`;
      }).join("");
    }

    // log
    const logBody=$("vbLogBody");
    if(vbState.log.length===0){
      logBody.innerHTML = `<div class="muted">Ch∆∞a c√≥ log.</div>`;
    } else {
      const view=vbState.log.slice(0,120);
      logBody.innerHTML = view.map(x=>{
        const badge = x.action==="PASS"?"‚úÖ":x.action==="FAIL"?"‚õî":x.action==="CALL"?"üé≤":x.action==="INIT"?"‚öôÔ∏è":x.action==="SHUFFLE"?"üîÄ":"‚Ä¢";
        const it = vbState.items[x.item] || {};
        const label = it.word ? it.word : x.item;
        return `<div class="item">
          <div><b>${badge} ${escapeHtml(x.action)}</b> ‚Äî <b>${escapeHtml(label)}</b></div>
          <div class="muted">${escapeHtml(x.at)} ‚Ä¢ ${escapeHtml(x.note||"")}</div>
        </div>`;
      }).join("");
    }

    vbEnsureButtons();
  }

  // vocab events
  $("vbStart").addEventListener("click", vbStart);
  $("vbMode").addEventListener("change", vbSetMode);
  $("vbNext").addEventListener("click", vbNext);
  $("vbPass").addEventListener("click", vbPass);
  $("vbFail").addEventListener("click", vbFail);
  $("vbUndo").addEventListener("click", vbUndo);
  $("vbShuffle").addEventListener("click", vbShuffle);
  $("vbCheck").addEventListener("click", vbCheck);
  $("vbReveal").addEventListener("click", vbReveal);
  $("vbExport").addEventListener("click", vbExport);
  $("vbReset").addEventListener("click", vbReset);
  $("vbAutoRun").addEventListener("change", (e)=> vbSetAuto(e.target.checked));
  $("vbAutoMs").addEventListener("change", ()=> { if($("vbAutoRun").checked) vbSetAuto(true); });

  // collapsible buttons (vocab)
  document.querySelectorAll('[data-toggle="vbPool"]').forEach(btn=>{
    btn.addEventListener("click", ()=>togglePanel("vbPoolBody", btn));
  });
  document.querySelectorAll('[data-toggle="vbFails"]').forEach(btn=>{
    btn.addEventListener("click", ()=>togglePanel("vbFailsBody", btn));
  });
  document.querySelectorAll('[data-toggle="vbLog"]').forEach(btn=>{
    btn.addEventListener("click", ()=>togglePanel("vbLogBody", btn));
  });

  // ========= App reset =========
  $("btnResetAll").addEventListener("click", ()=>{
    const ok=confirm("Reset app s·∫Ω x√≥a c·∫£ m·ª•c S·ªë v√† T·ª´ v·ª±ng (localStorage). B·∫°n ch·∫Øc ch·ª©?");
    if(!ok) return;
    localStorage.removeItem(LS_NUM);
    localStorage.removeItem(LS_VB);
    location.reload();
  });

  // ========= Keyboard shortcuts (context-aware) =========
  window.addEventListener("keydown", (e)=>{
    const tag=(e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
    const isTyping = (tag==="input" || tag==="textarea" || tag==="select");

    const onNumbers = !screens.numbers.classList.contains("hide");
    const onVocab = !screens.vocab.classList.contains("hide");

    // Ctrl/Cmd+Z for undo (even when not typing)
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="z"){
      e.preventDefault();
      if(onNumbers) numUndo();
      if(onVocab) vbUndo();
      return;
    }

    // If typing in vocab answer, Enter should check/pass conveniently
    if(onVocab && tag==="input" && e.target.id==="vbAnswer"){
      if(e.key==="Enter"){
        e.preventDefault();
        const ok = vbCheck();
        // n·∫øu ƒë√∫ng th√¨ pass lu√¥n (ti·ªán h·ªçc), n·∫øu sai th√¨ gi·ªØ ƒë·ªÉ b·∫°n b·∫•m Fail
        if(ok===true) vbPass();
      }
      return;
    }

    // avoid intercept while typing elsewhere
    if(isTyping) return;

    if(e.code==="Space"){
      e.preventDefault();
      if(onNumbers) numNext();
      if(onVocab) vbNext();
    } else if(e.code==="Enter"){
      e.preventDefault();
      if(onNumbers) numPass();
      if(onVocab) vbPass();
    } else if(e.key.toLowerCase()==="f"){
      e.preventDefault();
      if(onNumbers) numFail();
      if(onVocab) vbFail();
    }
  });

  // ========= Init =========
  // default to home
  showScreen("home");

  // load states
  numLoad();
  vbLoad();

  // keep all panels collapsed by default: we already set bodies as hide in HTML.
  // render modules
  numRender();
  vbRender();
})();
</script>
</body>
</html>

